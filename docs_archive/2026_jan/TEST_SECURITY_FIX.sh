#!/bin/bash

# Test Program Scoping Security Fix
# This script tests that Program Moderators can only see their program's data

echo "üß™ Testing Program Scoping Security Fix"
echo "========================================"
echo ""

# Test configuration
SERVER="https://prod.qsights.com"

echo "üìã Test Checklist:"
echo ""
echo "1. Login as Program Moderator"
echo "   - Email: [MODERATOR_EMAIL]"
echo "   - Password: [MODERATOR_PASSWORD]"
echo ""
echo "2. Navigate to Events/Activities page"
echo "   - URL: https://prod.qsights.com/activities"
echo ""
echo "3. Open Browser DevTools (F12)"
echo "   - Go to Network tab"
echo "   - Look for API calls to /api/activities"
echo ""
echo "4. Check API Request:"
echo "   - Should see: GET /api/activities?program_id=XXX"
echo "   - Where XXX is the moderator's assigned program_id"
echo ""
echo "5. Check Response:"
echo "   - Should ONLY contain activities from program XXX"
echo "   - Should NOT contain activities from other programs"
echo ""
echo "6. Verify UI:"
echo "   - Activities list shows ONLY their program's events"
echo "   - No events from other programs visible"
echo ""
echo "7. Check Console:"
echo "   - Should be NO errors"
echo "   - Should see successful API responses"
echo ""
echo "8. Test Other Pages:"
echo "   - Participants: Should only show their program's participants"
echo "   - Reports: Should only show their program's reports"
echo "   - Programs: Should only show their assigned program"
echo ""
echo "‚úÖ Expected Results:"
echo "   - Moderator sees ONLY their program's data"
echo "   - No data from other programs"
echo "   - No errors in console"
echo "   - All API calls include correct program_id filter"
echo ""
echo "‚ùå If you see data from other programs:"
echo "   - The fix is NOT working"
echo "   - Check Laravel logs: /var/www/QSightsOrg2.0/backend/storage/logs/laravel.log"
echo "   - Contact developer immediately"
echo ""
echo "üîç Advanced Testing (Manual API Call):"
echo ""
echo "Test 1: Valid request (should succeed)"
echo "curl -H 'Authorization: Bearer [TOKEN]' \\"
echo "     '$SERVER/api/activities?program_id=[MODERATOR_PROGRAM_ID]'"
echo ""
echo "Test 2: Invalid request (should return 403)"
echo "curl -H 'Authorization: Bearer [TOKEN]' \\"
echo "     '$SERVER/api/activities?program_id=[OTHER_PROGRAM_ID]'"
echo ""
echo "Test 3: No program_id (should auto-inject)"
echo "curl -H 'Authorization: Bearer [TOKEN]' \\"
echo "     '$SERVER/api/activities'"
echo ""
echo "========================================"
echo "üìû Support: Check DEPLOYMENT_COMPLETE_v2026.01.22d.md for details"
